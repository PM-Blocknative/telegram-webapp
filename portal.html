<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Community Portal</title>

  <!-- Telegram Mini-App SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- hCaptcha -->
  <script src="https://js.hcaptcha.com/1/api.js" async defer></script>

  <style>
    :root { color-scheme: var(--tg-color-scheme); }
    body  {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      margin:   0;  padding: 16px;
      background-color: var(--tg-theme-bg-color,  #fff);
      color:            var(--tg-theme-text-color, #000);
    }
    .container      { max-width: 500px; margin: 0 auto; text-align: center;
                      padding-bottom: env(safe-area-inset-bottom); }
    h1              { color: var(--tg-theme-button-color, #2481cc);
                      margin-bottom: 16px; font-size: 20px; font-weight: 600; }
    .welcome-text   { font-size: 15px; line-height: 1.5; margin-bottom: 24px;
                      color: var(--tg-theme-text-color, #333); opacity: .8; }
    .status-message { margin-top: 16px; padding: 12px; border-radius: 8px;
                      background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
                      font-size: 14px; }
    .success        { color: var(--tg-theme-button-color,       #28a745); }
    .error          { color: var(--tg-theme-destructive-text-color, #dc3545); }
    .debug-log      { margin-top: 20px; padding: 12px; border-radius: 8px;
                      background-color: var(--tg-theme-secondary-bg-color, #f5f5f5);
                      font-family: monospace; font-size: 12px; text-align: left;
                      white-space: pre-wrap; word-break: break-all;
                      max-height: 200px; overflow-y: auto;
                      color: var(--tg-theme-text-color, #666); }
    .copy-button    { margin-top: 8px; padding: 8px 16px; border: none; border-radius: 8px;
                      background-color: var(--tg-theme-button-color, #2481cc);
                      color: var(--tg-theme-button-text-color, #ffffff);
                      font-size: 14px; cursor: pointer; }
    .copy-button:active { opacity: .8; }
    .h-captcha      { display: flex; justify-content: center; margin: 20px 0; }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        background-color: var(--tg-theme-bg-color,  #1f1f1f);
        color:            var(--tg-theme-text-color, #fff);
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Community Verification</h1>

    <div class="welcome-text">
      Please complete the verification below to join our community.
      This helps us maintain a safe environment for all members.
    </div>

    <div class="h-captcha"
         data-sitekey="a6e82c3a-3eb6-4a42-b64a-b1e80c8cecc8"
         data-callback="onCaptchaSuccess"
         data-expired-callback="onCaptchaExpired"
         data-error-callback="onCaptchaError"
         data-theme="auto"></div>

    <div id="statusMessage" class="status-message" style="display:none;"></div>
    <div id="debugLog"     class="debug-log"     style="display:none;"></div>
    <button id="copyButton"  class="copy-button" style="display:none;">Copy Debug Logs</button>
    <button id="closeButton" class="copy-button" style="display:none;margin-left:8px;">
      Close Web App
    </button>
  </div>

  <script>
    /* ---------- helpers -------------------------------------------------- */
    const tg           = window.Telegram.WebApp;
    const statusEl     = document.getElementById('statusMessage');
    const debugEl      = document.getElementById('debugLog');
    const copyBtn      = document.getElementById('copyButton');
    const closeBtn     = document.getElementById('closeButton');

    let hCaptchaToken  = null;
    let isVerifying    = false;
    const debugLines   = [];

    function log (msg, type='info') {
      const ts   = new Date().toLocaleTimeString();
      const line = `[${ts}] ${typeof msg === 'object' ? JSON.stringify(msg) : msg}`;
      debugLines.push(line);
      debugEl.textContent   = debugLines.join('\n');
      debugEl.style.display = 'block';
      debugEl.scrollTop     = debugEl.scrollHeight;
      copyBtn.style.display = 'inline-block';
    }

    copyBtn.onclick = async () => {
      try {
        await navigator.clipboard.writeText(debugLines.join('\n'));
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy Debug Logs', 2_000);
      } catch (err) { log(`Error copying logs: ${err}`, 'error'); }
    };

    closeBtn.onclick = () => {
      try   { tg.close(); }
      catch { window.close(); }
    };

    /* ---------- init ------------------------------------------------------ */
    log('Initializing Telegram Web App…');
    log(`Platform: ${tg.platform}`);
    log(`Version:  ${tg.version}`);
    log(`InitData length: ${tg.initData?.length || 0}`);
    log(`URL: ${location.href}`);

    tg.ready();           log('Web App ready');
    tg.expand();          log('Web App expanded');
    document.body.setAttribute('data-theme', tg.colorScheme);
    log(`Theme: ${tg.colorScheme}`);

    tg.MainButton.setParams({
      text:       'COMPLETE VERIFICATION',
      is_visible: false,
      color:      tg.themeParams.button_color,
      text_color: tg.themeParams.button_text_color
    });

    /* ---------- hCaptcha -------------------------------------------------- */
    window.onCaptchaSuccess = token => {
      log('hCaptcha success');
      hCaptchaToken = token;
      statusEl.className   = 'status-message success';
      statusEl.style.display = 'block';
      statusEl.textContent   = 'Verification successful! Tap the button below.';
      tg.MainButton.setText('COMPLETE VERIFICATION');
      tg.MainButton.show();
    };
    window.onCaptchaExpired = () => {
      log('hCaptcha expired');
      hCaptchaToken = null;
      statusEl.className   = 'status-message error';
      statusEl.style.display = 'block';
      statusEl.textContent   = 'Verification expired. Please try again.';
      tg.MainButton.hide();
    };
    window.onCaptchaError = e => {
      log(`hCaptcha error: ${e}`, 'error');
      statusEl.className   = 'status-message error';
      statusEl.style.display = 'block';
      statusEl.textContent   = 'An error occurred. Please try again.';
      tg.MainButton.hide();
    };

    /* ---------- verification flow ---------------------------------------- */
    async function completeVerification () {
      log('Begin verification…');

      if (!hCaptchaToken || isVerifying) {
        log(`Blocked: token=${!!hCaptchaToken} verifying=${isVerifying}`);
        return;
      }
      isVerifying = true;

      /* session lookup --------------------------------------------------- */
      let sessionId   = null;
      let userData    = {};
      try {
        if (tg.initData) {                       // guard against empty string
          const p = new URLSearchParams(tg.initData);
          userData = Object.fromEntries(p);
          if (userData.user)
            userData.user = JSON.parse(decodeURIComponent(userData.user));
          log(`User parsed: ${userData.user.id} (${userData.user.username||'no username'})`);
        }

        // 1) query_id available when launched from *real* web_app button
        if (tg.initDataUnsafe?.query_id) {
          sessionId = tg.initDataUnsafe.query_id;
          log(`Found sessionId via query_id: ${sessionId}`);
        }
        // 2) fallback: ?session=… in the URL
        if (!sessionId) {
          sessionId = new URLSearchParams(location.search).get('session');
          if (sessionId) log(`Found sessionId via query-string: ${sessionId}`);
        }

        log('Available data dump:',
            { hasInitData: !!tg.initData, initDataUnsafe: tg.initDataUnsafe,
              userData, urlParams: Object.fromEntries(new URLSearchParams(location.search)) });

      } catch (err) { log(`Data parse error: ${err}`, 'error'); }

      if (!sessionId) {
        log('ERROR: No sessionId found');
        statusEl.className   = 'status-message error';
        statusEl.style.display = 'block';
        statusEl.textContent   = 'Invalid verification link. Please start again.';
        isVerifying = false;
        return;
      }

      /* assemble payload ------------------------------------------------- */
      const payload = {
        userId:   userData?.user?.id || tg.initDataUnsafe?.user?.id,
        timestamp: Date.now(),
        success:   true,
        sessionId,
        captchaToken: hCaptchaToken,
        auth_date:    userData?.auth_date,
        hash:         userData?.hash,
        chat_instance:userData?.chat_instance,
        chat_type:    userData?.chat_type
      };
      log(`Payload ready for user ${payload.userId}`);

      /* send back to bot ------------------------------------------------- */
      tg.MainButton.showProgress();
      statusEl.className   = 'status-message';
      statusEl.style.display = 'block';
      statusEl.textContent   = 'Completing verification…';

      try {
        await tg.sendData(JSON.stringify(payload));
        log('Data sent to bot');
        tg.MainButton.hideProgress();
        tg.MainButton.hide();
        statusEl.className = 'status-message success';
        statusEl.textContent = 'Verification complete! Tap “Close Web App”.';
        closeBtn.style.display = 'inline-block';
      } catch (err) {
        log(`sendData error: ${err}`, 'error');
        tg.MainButton.hideProgress();
        statusEl.className = 'status-message error';
        statusEl.textContent = 'Failed to contact bot. Please try again.';
        isVerifying = false;
      }
    }

    tg.MainButton.onClick(completeVerification);
    tg.BackButton.onClick(() => { try { tg.close(); } catch { window.close(); } });

    /* ---------- global error trapping ---------------------------------- */
    addEventListener('error', e => {
      log(`Global error: ${e.error}`, 'error');
      statusEl.className   = 'status-message error';
      statusEl.style.display = 'block';
      statusEl.textContent   = 'An unexpected error occurred.';
    });
    addEventListener('unhandledrejection', e => {
      log(`Unhandled rejection: ${e.reason}`, 'error');
      statusEl.className   = 'status-message error';
      statusEl.style.display = 'block';
      statusEl.textContent   = 'An unexpected error occurred.';
    });
    if (tg.onEvent) tg.onEvent('error', err => log(`WebApp error: ${err}`, 'error'));
  </script>
</body>
</html>
